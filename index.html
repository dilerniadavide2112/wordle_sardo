<script>
let gameEnabled = false;

const WORDS = ["cantu","terra","limba","domus","abbae","abbas","agusu","akatu", "amore","annos","arras","artu","asinu","attzu","bacca","ballu","battu", "berru","bidda","binu","boghe","bonu","braxu","bussu","cabbu", "caded", "camin","campu","canes","capru","carri","ceddu","chelu","chena","chida", "chidu","coggi","conca","corru","costa","craba","crobu","cuadu","curre", "dente","dinai","dridu","fangu","fattu","femmu", "ferro","figus","filu", "foghe","forru","fradi","frori","fundu","gattu","genna","giara","goccu", "granu","herra","ibidu","istru","latte","legnu","libru","littu","logu", "macas","manus","mattu","melis","menta", "merca","metru","missa","molle", "monte","moru","mughe","nassa","niedu","ninnu","nuddu","olivu","omini", "orru","pane","pedde","perda","pietu","pilus","pinna","pitzus","planu", "ponte","porru","pratu","prenu", "punta","putzu","rabbu","randa","rattu", "riccu","rimas","rinnu","rocca","roghe","rueda","sabba","santu","sartu", "sedda","serra","siddu","sinnu","solee","sonnu","spina","stadu","stolu", "suddu","tabba","tanca", "tattu","terru","tissu","torru","trigu","umbra", "undas","ungra","usciu","vacca","valle","vesta","vidda","vinu","virga", "zente","zinnu","bentu","abbae","abbas","abidu","acqua","addiu","agudu","aiadu","ajudu","alidu", "altu","amadu","amare","ambra","annos","ansia","apriu","aridu","arras","artu","asinu","attzu","auras","azotu", "bacas","bagna","ballu","battu","beidu","bentu","berru","bidda","binu","boghe","bonu","braxu","bravu","bussu", "cabbu","caded","camin","campu","canes","capru","carri","ceddu","chelu","chena", "chida","chidu","coggi","coldu","conca","corru","costa","craba","crobu","cuadu","curre","dente","dinai","domus","dridu","durus","fache","fangu", "fattu","femmu","ferro","figus","filu","foghe", "forru","fradi","fridu","frori","fundu","gattu","genna","giara","goccu","granu","herra","ibidu","imidu","istru","lattu","latte","legnu","libru","littu","logu","luciu","macas","maled", "manus", "mariu","mattu","melis","menta","merca","metru","missa","moddu","molle","monte","moru","mughe","nassa","niedu","ninnu","nuddu","olivu","omini","orrua","ossu","paber","panee","pannu","pedde", "perda","pesca","piana","pietu", "pilus","pinna","pintu","pitzus","planu","ponte","porru","pratu","prenu","punta","putzu","rabbu","randa","rattu","regnu","riccu","rimas","rinnu","rocca","roghe", "rueda","sabba","santu","sartu","sedda","serra","siddu","sinnu","solee", "sonnu","spada","spina","stadu","stolu","suddu","tabba","tanca","tattu","tenre","terru","tissu","torru","trigu","umbra", "undas","ungra","usciu","vacua","vacca","valle","vesta","vidda","vinu","virga","zente","zinnu","zoccu","abbidu", "abbaru","abeta","abidu","abinu","accas","acidu","acutu","agidu","ajuru","alenu", "alidu","amada","amidu","anniu","apidu","aratu","ardiu","aridu","arriu","aspre","attiu","augas","bagna","baldu","balia","barca","bentu","bidas","bighe", "bionu","boidu","bolla","branu","brida", "brutu","cabra","cairu","caldu","cantu","carbu","caria","casca","cattu","cennu","chena","cibru","coddu","cortu","cress","cuasi","curdu","dannu","deidu","dertu","doble","doltu","draga","durra", "faina","fattu","feddu","filla","finas","fitta","flori","foras","fremu","fridu","fundu","gabbu","galdu","garbu","gattu","ghidu","giogu","gradu","ibadu","impon","incas","infiu","intre","isola", "istau","laduu","lamas","lassu","lentu", "limba","linna","littu","lobiu","luddu","lumen","macas","madru","malas","manca","mardu","mascu","matta","meldu","mentu","mesti","millu","modda","mundu", "murta","nassa","niedu","noddu","noras","notte","ogliu","omadu","onore","opidu", "orosu","ossia","paber","pagae","palas","pandu","parru","pattu","pedru","penna","pesas","pillu","pinna","piras", "poddu","poldu","prama","prena","puddu","puntu","raddu","ramas","randa","redda","rescu","riccu","rissu","rivas","robba", "ruddu","sabba","sacru","saldu","sanas","sardu","seddu","senna","serru", "sessa","sibiu","simba","sinna","soddu","soldu","sonnu","spadu","stela","stidu","suddu","tanca","tardu","tella","tenni","terra","tinta","tittu","torra","tundu", "turre","umbra","ungiu","usura", "vacua","vagus","valdu","varra","veddu","veldu","venna","verru","vidda","vigiu","virga","zinnu","zoccu","aberu","aeras","afidu","ainas","ainos","amigu","amore","ampru","andat","anima","antru", "aostu", "arbus","arena","armas","artes","ascia","asulu","badde","banca","bannu","basca","bator","belus","benit","birde","borta","bosas","botru","brodu","bujiu","busta","caddu","calae","canna", "carga","carru","carta","casus","catza","cerva", "chitu","cibus","cimas","cintu","codas","conto","coros","cosas","cozzu","crara","creja","crona","cruce","culos","cursu","custu","daret","datas", "deche","ditzu","dolos","donzi","dromi","duos","ebbas","erbas","faghu","fames","favas", "festa","filas","fizos","fogus","folas","forte","funes","furas","fuste","ganas","gioia","giras","gomai", "gopai","gustu","janas","janna","josso","justu","lanas","lardu","largu","lebiu","lenas","lezes","linas","lizus","longu","luche", "lunas","maccu","malus","mamas","mamma","mancu","maris","marra", "matas","meigu","melas","mesus","miras","modde","molas","moras","mudus","mulas","mulus","muras","murus","musca","muscu","narat","naris","nasus","neula","nosus","nughe", "nuras","odius","olias", "ortus","ossas","ozzus","panis","paras","parte","passu","pazas","pedes","penas","perla","petza","pigat","pinta","pisci","pisus","pitzu","ponit","porcu","posta","pruna","pudda","pupas","ranas", "renas","resta", "robas","rodas","rosas","ruius","sacca","salas","scala","scola","segat","segus","serus","siccu","sinus","sogas","sorus","sucus","taula","tazas", "telas","tempu","tetas","tontu", "tostu","totus","tuvus","tzius","usat","vacas","vasat","vasus","velas","venas","vidas","visus","vitas","zassu","zegus","zelus","zerru","zestu","ziras","zonas","zuras"];
const WORD_SET = new Set(WORDS);

const epoch = new Date(2023, 0, 1);
const dayIndex = Math.floor((Date.now() - epoch) / 86400000);
const solution = WORDS[dayIndex % WORDS.length];

const maxRows = 6;
let currentRow = 0;
let currentGuess = "";
let guesses = [];

const game = document.getElementById("game");
game.style.visibility = "visible";
const rows = [];

for (let r = 0; r < maxRows; r++) {
  const row = document.createElement("div");
  row.className = "row";
  const cells = [];
  for (let c = 0; c < 5; c++) {
    const cell = document.createElement("div");
    cell.className = "cell";
    row.appendChild(cell);
    cells.push(cell);
  }
  game.appendChild(row);
  rows.push(cells);
}

const msg = document.getElementById("msg");
const overlay = document.getElementById("overlay");
const rulesOverlay = document.getElementById("rulesOverlay");
const startOverlay = document.getElementById("startOverlay");
const result = document.getElementById("result");
const solutionBox = document.getElementById("solution");
const menuBtn = document.getElementById("menuBtn");
const menu = document.getElementById("menu");

function showMsg(t) {
  msg.textContent = t;
  setTimeout(() => msg.textContent = "", 2000);
}

function renderGuess(guess) {
  const sol = solution.split("");
  const count = {};
  sol.forEach(c => count[c] = (count[c] || 0) + 1);

  guess.split("").forEach((c, i) => {
    const cell = rows[currentRow][i];
    cell.textContent = c.toUpperCase();
    if (c === sol[i]) {
      cell.classList.add("correct");
      count[c]--;
    }
  });

  guess.split("").forEach((c, i) => {
    const cell = rows[currentRow][i];
    if (cell.classList.contains("correct")) return;
    if (sol.includes(c) && count[c] > 0) {
      cell.classList.add("present");
      count[c]--;
    } else cell.classList.add("absent");
  });

  guesses.push(guess);
  currentRow++;
}

function submitGuess() {
  if (!gameEnabled || currentGuess.length !== 5) return;

  if (!WORD_SET.has(currentGuess)) {
    showMsg("Sa parola non esistit ðŸ˜¤");
    return;
  }

  renderGuess(currentGuess);

  if (currentGuess === solution || currentRow >= maxRows) showEnd();
  currentGuess = "";
}

function buildShare() {
  let t = "";
  guesses.forEach((g, r) => {
    for (let i = 0; i < 5; i++) {
      const c = rows[r][i];
      t += c.classList.contains("correct") ? "ðŸŸ©" : c.classList.contains("present") ? "ðŸŸ¨" : "â¬›";
    }
    t += "\n";
  });

  window.shareText = "Wordle Sardo " + dayIndex + " " +
    (guesses[guesses.length - 1] === solution ? guesses.length + "/6" : "X/6")
    + "\n\n" + t;
}

function loadStats() {
  const stats = JSON.parse(localStorage.getItem("wordleSardoStats") || '{}');
  return {
    wins: stats.wins || 0,
    losses: stats.losses || 0,
    streak: stats.streak || 0,
    maxStreak: stats.maxStreak || 0,
    winDist: stats.winDist || [0,0,0,0,0,0],
  };
}

function saveStats(stats) {
  localStorage.setItem("wordleSardoStats", JSON.stringify(stats));
}

function showStats(win, attempts) {
  const stats = loadStats();

  if (win) {
    stats.wins++;
    stats.streak++;
    if (stats.streak > stats.maxStreak) stats.maxStreak = stats.streak;
    stats.winDist[attempts - 1]++;
  } else {
    stats.losses++;
    stats.streak = 0;
  }

  saveStats(stats);

  let perc = stats.wins + stats.losses > 0 ? Math.round(100 * stats.wins / (stats.wins + stats.losses)) : 0;

  solutionBox.innerHTML = `
    ${window.shareText.split("\n\n")[1]}<br><br>
    Statistiche:<br>
    Vittorie: ${stats.wins} (${perc}%)<br>
    Vittorie di fila: ${stats.streak} (max ${stats.maxStreak})<br>
    Sconfitte: ${stats.losses}<br>
    Distribuzione vittorie:<br>
    ${stats.winDist.map((n,i)=>`${i+1}: ${n}`).join(" | ")}
  `;
}

function showEnd() {
  const win = guesses[guesses.length - 1] === solution;
  result.textContent = win ? "BRAVU" : "SPACCIAU";
  buildShare();
  showStats(win, guesses.length);
  overlay.classList.add("show");
}

// TASTIERA VIRTUALE
document.querySelectorAll("#keyboard button").forEach(b => {
  b.onclick = () => {
    if (!gameEnabled) return;
    const k = b.textContent;

    if (k === "ENTER") submitGuess();
    else if (k === "âŒ«") {
      if (currentGuess.length > 0) {
        currentGuess = currentGuess.slice(0, -1);
        rows[currentRow][currentGuess.length].textContent = "";
      }
    } else if (currentGuess.length < 5) {
      currentGuess += k.toLowerCase();
      rows[currentRow][currentGuess.length - 1].textContent = k.toUpperCase();
    }
  };
});

// TASTIERA FISICA
document.addEventListener("keydown", e => {
  if (!gameEnabled) return;
  const k = e.key.toUpperCase();

  if (k === "ENTER") submitGuess();
  else if (k === "BACKSPACE") {
    if (currentGuess.length > 0) {
      currentGuess = currentGuess.slice(0, -1);
      rows[currentRow][currentGuess.length].textContent = "";
    }
  } else if (/^[A-Z]$/.test(k) && currentGuess.length < 5) {
    currentGuess += k.toLowerCase();
    rows[currentRow][currentGuess.length - 1].textContent = k.toUpperCase();
  }
});

// MENU
menuBtn.onclick = () => {
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};

// PULSANTI MENU
document.getElementById("openRules").onclick = () => rulesOverlay.classList.add("show");
document.getElementById("rulesOk").onclick = () => rulesOverlay.classList.remove("show");
document.getElementById("menuRules").onclick = () => {
  rulesOverlay.classList.add("show");
  menu.style.display = "none";
};
document.getElementById("menuShare").onclick = () => {
  doShare();
  menu.style.display = "none";
};
document.getElementById("menuClose").onclick = () => menu.style.display = "none";
document.getElementById("closeBtn").onclick = () => overlay.classList.remove("show");

// START
document.getElementById("startPlay").onclick = () => {
  startOverlay.classList.remove("show");
  gameEnabled = true;
};

// SHARE
function doShare() {
  if (navigator.share) navigator.share({ text: window.shareText });
  else {
    navigator.clipboard.writeText(window.shareText);
    alert("Testo copiato negli appunti!");
  }
}
document.getElementById("shareBtn").onclick = doShare;
</script>
